/* toolbar-1.0.0 follow.js Date:2016-11-17 18:06:41 */
define("TB_ROOT/js2/follow",function(require,a,b){"use strict";require("JDF_UI/js2/switchable.js");var d=require("JDF_UNIT/js2/event.js");var e=require("TB_ROOT/js2/tools.js");var f=function(a){var b=this;this.name="follow",this._toolbar=pageConfig.toolbar.settings,this.container=a.$content,this.wrap=this.container.parent(),this.contentHeight=this.container.innerHeight(),this.cutProductCount=0,this.init(),pageConfig.toolbar.eventDispatcher.bind(this.name+"PanelOpen",function(){b.container.find(".follow-tab-content-slected").hasClass("follow-product-list")&&b.product()})};f.prototype={init:function(){this.initTab()},render:function(){},initTab:function(){var a=this;var b='            	<div class="jdm-tbar-tipbox2">            		<div class="tip-inner">            			<i class="i-loading"></i>                    </div>                </div>';var c='				<div class="follow-tabnav">					<ul>						<li class="ui-switchable-item">							<a clstag="${toolbar.clsPageType}|keycount|cebianlan_${toolbar.clsPageType}_${name}|product">\u5546\u54c1</a>							<span></span>						</li>						<li class="ui-switchable-item">							<a clstag="${toolbar.clsPageType}|keycount|cebianlan_${toolbar.clsPageType}_${name}|shop">\u5e97\u94fa</a>							<span></span>						</li>						<li class="ui-switchable-item">							<a clstag="${toolbar.clsPageType}|keycount|cebianlan_${toolbar.clsPageType}_${name}|act">\u6d3b\u52a8</a>						</li>					</ul>				</div>';var d='				<div class="follow-tabcontents">					<div class="follow-tab-content follow-product-list">'+b+'					</div>					<div class="follow-tab-content follow-shop-list">'+b+'					</div>				 	<div class="follow-tab-content follow-act-list">'+b+"				 	</div>				</div>";this.container.before(c.process({name:a.name,toolbar:a._toolbar})).html(d),a.wrap.switchable({type:"slider",navItem:"ui-switchable-item",navSelectedClass:"curr",mainClass:"follow-tab-content",mainSelectedClass:"follow-tab-content-slected",contentClass:"follow-tabcontents",callback:function(b){var c=a.contentHeight-50;var d=this.main.eq(b);d.find(".jdm-tbar-tipbox2").parent().height(c),d.height("auto").siblings().height(c);var e=this.nav.eq(b).data("loaded");if(!e)switch(b){case 0:a.product(!0);break;case 1:a.shop();break;case 2:a.act()}e&&d.hasClass("follow-product-list")&&a.product(),this.nav.eq(b).data("loaded",!0)},easing:"swing"})},product:function(a){var b=this,c="//follow-soa.jd.com/rpc/product/queryForPageBySearch";b.get(c,function(c){b.renderProduct(c),a&&(b.unfollowPro(),b.bindHover(),b.updateTip())})},shop:function(){var a=this,b="//follow-soa.jd.com/rpc/vender/loadfollowlist.do";a.get(b,function(b){a._renderShop(b)})},act:function(){var a=this;var b="//follow-soa.jd.com/rpc/activity/queryForPage?callback=?";a.get(b,function(b){a._renderAct(b)})},renderProduct:function(a){var b=$(".follow-product-list",this.container);var c="";var d=a.data.list;var e=[];var f={};if(0===d.length)return pageConfig.toolbar.setStatus(b,"\u8fd8\u6ca1\u6709\u5173\u6ce8\u7684\u5546\u54c1\u54e6~<br>\u5173\u6ce8\u540e\uff0c\u5f53\u5546\u54c1\u964d\u4ef7\u3001\u4fc3\u9500\u3001\u8865\u8d27\u4f1a\u63d0\u9192\u60a8\u54e6~"),void b.find(".jdm-tbar-tipbox2").parent().height(this.contentHeight-50);for(var g in d)if(d.hasOwnProperty(g)){var h=d[g];c+='    				<li class="fpl-item">    					<a href="//item.jd.com/'+h.productId+'.html" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|item" class="img-wrap" target="_blank" title="'+h.productName+'">    						<img src="'+pageConfig.FN_GetImageDomain(h.productId)+"/n0/s100x100_"+h.productLogo+'" width="100" height="100"/>    					</a>    					<a class="add-cart-button" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|addtocart" href="//gate.jd.com/InitCart.aspx?pid='+h.productId+'&pcount=1&ptype=1" target="_blank">\u52a0\u5165\u8d2d\u7269\u8f66</a>    					<a href="//item.jd.com/'+h.productId+'.html" target="_blank" class="price J-p-'+h.productId+'" ></a>    					<a href="javascript:;" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|del" class="fpl-remove" pid="'+h.productId+'"></a>    				</li>',e.push(h.productId),f[h.productId]=h.followedPrice}this._renderPrices(e,f),this.cutPriceTips(),c='	        	<div class="follow-head-tip"><div></div><span class="close-tip"></span></div>	        	<ul>'+c+'</ul>	        	<a href="//t.jd.com/home/follow" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|more_product" class="follow-bottom-more" target="_blank">\u67e5\u770b\u66f4\u591a\u5173\u6ce8\u5546\u54c1 >></a>',$(b).html(c)},_renderShop:function(a){var b="";var c=a.data;var d=$(".follow-shop-list",this.container);var e=[];var f,g;if(0===c.length)return pageConfig.toolbar.setStatus(d,"\u8fd8\u6ca1\u6709\u5173\u6ce8\u7684\u5e97\u94fa\u54e6~<br>\u5173\u6ce8\u540e\uff0c\u5f53\u5e97\u94fa\u6709\u4fc3\u9500\u3001\u4e0a\u65b0\u65f6\u4f1a\u63d0\u9192\u60a8\u54e6~"),void d.find(".jdm-tbar-tipbox2").parent().height(this.contentHeight-50);for(var h in c)if(c.hasOwnProperty(h)){var i=c[h];null===i.logoURI||void 0===i.logoURI||""===i.logoURI?(f="//misc.360buyimg.com/lib/img/e/blank.gif",g="error-img"):(f=i.logoURI,g=""),e.push(i.venderId),b+='    					<li class="fsl-item">    						<div class="shop-logo">                              <a href="//mall.jd.com/index-'+i.venderId+'.html" target="_blank"></a>                              <img class=" '+g+'" src="'+f+'">                            </div>    						<div class="shop-info">    							<div class="si-name"><a target="_blank" href="//mall.jd.com/index-'+i.venderId+'.html">'+i.venderName+'</a></div>    							<a href="//mall.jd.com/index-'+i.venderId+'.html" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|go_shop" class="si-button" target="_blank">\u8fdb\u5165\u5e97\u94fa ></a>    						</div>    					</li>'}b="            	<ul>"+b+'</ul>            	<a href="//t.jd.com/vender/followVenderList.action" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|more_shop" class="follow-bottom-more" target="_blank">\u66f4\u591a\u5173\u6ce8\u5546\u94fa >></a>',d.html(b)},_renderAct:function(a){var b=window.pageConfig.timestamp||(new Date).getTime();var c=a.data.list;var d="";var e=$(".follow-act-list",this.container);var f="";if(null===c)return pageConfig.toolbar.setStatus(e,"\u8fd8\u6ca1\u6709\u5173\u6ce8\u7684\u6d3b\u52a8\u54e6~<br>\u5173\u6ce8\u540e\uff0c\u5f53\u6d3b\u52a8\u6709\u65b0\u52a8\u6001\u65f6\u4f1a\u63d0\u9192\u60a8\u54e6~"),void e.find(".jdm-tbar-tipbox2").parent().height(this.contentHeight-50);for(var g in c)if(c.hasOwnProperty(g)){var h=c[g];var i;i=h.endDate.split(/\D/);var j=new Date(i[0],i[1]-1,i[2],i[3],i[4],i[5]);i=h.startDate.split(/\D/);var k=new Date(i[0],i[1]-1,i[2],i[3],i[4],i[5]);var l="";if(h.endDate=j.valueOf(),h.startDate=k.valueOf(),h.endDate<b)continue;h.startDate<b&&(d="act-now",l=j.getFullYear()+"."+(j.getMonth()+1)+"."+j.getDate()+"\u7ed3\u675f"),h.endDate-b<=864e5&&(d="act-soonEnd"),h.startDate>b&&(d="act-unstart",l=k.getFullYear()+"."+(k.getMonth()+1)+"."+k.getDate()+"\u5f00\u59cb"),f+='<li class="fal-item '+d+'">                            <div class="act-status-bg"></div>    						<p class="act-name" title="'+h.activityName+'">'+h.activityName+'</p>    						<p class="act-enddate">'+l+'</p>    						<a href="'+h.activityUrl+'" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|go_act" target="_blank" class="act-botton">\u8fdb\u5165\u6d3b\u52a8 ></a>    					</li>'}f="            	<ul>"+f+'</ul>            	<a href="//t.jd.com/activity/followActivityList.action" clstag="'+this._toolbar.clsPageType+"|keycount|cebianlan_"+this._toolbar.clsPageType+"_"+this.name+'|more_act" class="follow-bottom-more" target="_blank">\u66f4\u591a\u5173\u6ce8\u6d3b\u52a8 >></a>',e.html(f)},get:function(a,b){$.ajax({url:a,type:"get",dataType:"jsonp",scriptCharset:"utf-8",data:{indexPage:1,pageSize:50,ext:!0,sysName:"item.jd.com"},success:function(a){b.call(this,a)}})},_renderPrices:function(a,b){var c=this;c.cutProductCount=0,e.priceNum({skus:a,$el:c.container,callback:function(a,d){if(-1===parseInt(d.p,10))c.container.find(".J-p-"+a).siblings(".add-cart-button").remove();else{var e=(b[a]-d.p).toFixed(2);if(e>0){var f='<span class="cut-price" data-tips="\u6bd4\u5173\u6ce8\u65f6\u964d\u4e86<b>'+e+'</b>\u5143">\u964d</span>';c.container.find(".J-p-"+a).append(f),c.container.find(".J-p-"+a).parent().data("cutPrice",!0),c.cutProductCount++}}},complete:function(){d.trigger("updateTip")}})},updateTip:function(){var a=this;d.on("updateTip",function(){var b=a.container.find(".follow-head-tip");a.cutProductCount>0?$("div",b).html('<a href="//t.jd.com/product/followProductList.action?isReduce=true" clstag="'+a._toolbar.clsPageType+"|keycount|cebianlan_"+a._toolbar.clsPageType+"_"+a.name+'|reduced_product" target="_blank">'+a.cutProductCount+"\u4e2a\u5173\u6ce8\u5546\u54c1\u964d\u4ef7\u4e86\u54e6~</a>"):b.hide(),b.find(".close-tip").bind("click",function(){b.hide()})})},unfollowPro:function(){var a=this;this.container.delegate(".fpl-remove","click",function(){var b=$(this);var c=b.attr("pid");var e="//follow-soa.jd.com/rpc/product/batchUnfollow?callback=?";$.ajax({url:e,type:"get",dataType:"jsonp",data:{productIds:c,sysName:"item.jd.com"},success:function(c){c.success&&(b.parent().fadeOut(),b.parent().data("cutPrice")&&(a.cutProductCount--,d.trigger("updateTip")))}})})},cutPriceTips:function(){var a=$('<div class="cut-price-tip"><div class="tip-content"></div><b class="tip-arrow"></b></div>');var b=$(window).width();$("body").append(a),this.container.delegate(".cut-price","mouseenter",function(){var c=$(this).attr("data-tips");var d=$(this).offset();a.find(".tip-content").html(c);var e=a.width();var f=d.left;var g=d.top+25;f+e>b&&(a.addClass("cut-price-tip-right"),f-=e),a.css({left:f,top:g}).show()}),this.container.delegate(".cut-price","mouseleave",function(){a.hide().removeClass("cut-price-tip-right")})},bindHover:function(){this.container.delegate(".fpl-item","mouseenter mouseleave",function(a){"mouseenter"==a.type?$(this).addClass("fpl-item-hover"):$(this).removeClass("fpl-item-hover")})}},b.exports=f});
